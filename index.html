<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãŠæ°—ã«å…¥ã‚Šã‚¢ãƒ«ãƒãƒ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µã‚¤ãƒˆ</title>
    <!-- Tailwind CSS CDNã‚’èª­ã¿è¾¼ã¿ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ãƒ•ã‚©ãƒ³ãƒˆè¨­å®š -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+JP:wght@100..900&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight text-indigo-400">
                ãƒã‚¤ãƒ»ã‚¢ãƒ«ãƒãƒ ãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼
            </h1>
            <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <p id="user-info" class="text-gray-400 mt-2">Firebaseè¨­å®šã‚’ãƒã‚§ãƒƒã‚¯ä¸­...</p>
        </header>

        <!-- æ–°ã—ã„ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  -->
        <section id="review-form" class="bg-gray-800 p-6 rounded-xl shadow-2xl mb-12 border border-gray-700">
            <h2 class="text-2xl font-bold mb-5 reorganize_text_to_be_more_dynamic_than_a_bullet_pointtext-indigo-300">æ–°ã—ã„ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¿½åŠ </h2>
            <form id="album-review-form" class="space-y-4">
                <div>
                    <label for="album-title" class="block text-sm font-medium text-gray-300 mb-1">ã‚¢ãƒ«ãƒãƒ å</label>
                    <input type="text" id="album-title" required 
                           class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 transition">
                </div>
                <div>
                    <label for="artist-name" class="block text-sm font-medium text-gray-300 mb-1">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆå</label>
                    <input type="text" id="artist-name" required 
                           class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 transition">
                </div>
                <div>
                    <label for="album-image-file" class="block text-sm font-medium text-gray-300 mb-1">ã‚«ãƒãƒ¼ç”»åƒãƒ•ã‚¡ã‚¤ãƒ« (ä»»æ„)</label>
                    <input type="file" id="album-image-file" accept="image/*"
                           class="w-full file:mr-4 file:py-2 file:px-4
                                  file:rounded-lg file:border-0
                                  file:text-sm file:font-semibold
                                  file:bg-indigo-500 file:text-white
                                  hover:file:bg-indigo-600
                                  p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-300 transition">
                    <p class="text-xs text-gray-500 mt-1">â€»Base64ã§ä¿å­˜ã•ã‚Œã¾ã™</p>
                </div>
                <div>
                    <label for="rating" class="block text-sm font-medium text-gray-300 mb-1">è©•ä¾¡ (1ã€œ5)</label>
                    <input type="number" id="rating" min="1" max="5" required 
                           class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 transition">
                </div>
                <div>
                    <label for="review-text" class="block text-sm font-medium text-gray-300 mb-1">ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ¬æ–‡</label>
                    <textarea id="review-text" rows="4" required 
                              class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 transition"></textarea>
                </div>
                <button type="submit" id="submit-button" disabled
                        class="w-full py-3 px-4 bg-gray-600 text-white font-semibold rounded-lg shadow-md transition transform focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-900 disabled:opacity-50 cursor-not-allowed">
                    æ¥ç¶šä¸­...
                </button>
            </form>
            <div id="message-box" class="mt-4 p-3 rounded-lg text-center hidden"></div>
        </section>

        <!-- ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
        <section id="review-list-container">
            <h2 class="text-2xl font-bold mb-6 text-indigo-300 border-b border-gray-700 pb-2">ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§</h2>

            <!-- æ¤œç´¢å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
            <div class="mb-6">
                <label for="search-artist" class="block text-sm font-medium text-gray-300 mb-1">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã§æ¤œç´¢</label>
                <input type="text" id="search-artist" placeholder="ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã‚’å…¥åŠ›..."
                       class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 transition">
            </div>

            <div id="reviews-list" class="space-y-6">
                <!-- ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
            </div>
            <p id="no-reviews-message" class="text-center text-gray-500 mt-8">
                Firebaseè¨­å®šã‚’ãƒã‚§ãƒƒã‚¯ä¸­...
            </p>
        </section>
    </div>

    <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒŠ (HTMLã®æœ€å¾Œã«é…ç½®) -->
    <div id="custom-modal-container"></div>

    <!-- Firebase SDKã®èª­ã¿è¾¼ã¿ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestoreã®ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’è¨­å®š (ãƒ‡ãƒãƒƒã‚°ç”¨)
        setLogLevel('Debug');

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let db = null;
        let allReviewsData = []; 
        let isFirestoreReady = false; 

        // DOMè¦ç´ ã®å‚ç…§
        const form = document.getElementById('album-review-form');
        const reviewsList = document.getElementById('reviews-list');
        const noReviewsMessage = document.getElementById('no-reviews-message');
        const messageBox = document.getElementById('message-box');
        const albumImageFileInput = document.getElementById('album-image-file');
        const searchArtistInput = document.getElementById('search-artist');
        const userInfoDisplay = document.getElementById('user-info');
        const submitButton = document.getElementById('submit-button');
        
        const COLLECTION_NAME = 'reviews';
        const FALLBACK_IMAGE_URL = 'https://placehold.co/100x100/374151/E5E7EB?text=Cover';

        // ==========================================================
        // FirebaseåˆæœŸåŒ–ã¨èªè¨¼
        // ==========================================================
        async function initializeFirebase() {
            // å¿…é ˆã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’å–å¾—ã—ã€æœªå®šç¾©ã®å ´åˆã¯ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            // JSON.parseãŒå¤±æ•—ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€try/catchã§ä¿è­·
            let firebaseConfig = {};
            try {
                firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            } catch (e) {
                console.error("Error parsing __firebase_config:", e);
                // firebaseConfigã¯ç©ºã®ã¾ã¾
            }
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            const configIsMissing = Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId;

            if (configIsMissing) {
                // ğŸš¨ è¨­å®šæƒ…å ±ä¸è¶³ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†
                console.error("è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼: Firebase ConfigurationãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹ã€ä¸å®Œå…¨ã§ã™ã€‚");
                userInfoDisplay.className = 'text-red-400 font-bold mt-2 p-2 bg-red-900 bg-opacity-30 rounded-lg';
                userInfoDisplay.textContent = 'ã€è‡´å‘½çš„ãªè¨­å®šã‚¨ãƒ©ãƒ¼ã€‘ãƒ‡ãƒ¼ã‚¿åŒæœŸè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æŠ•ç¨¿ãƒ»ç·¨é›†ã¯ã§ãã¾ã›ã‚“ã€‚';
                noReviewsMessage.textContent = 'ãƒ‡ãƒ¼ã‚¿æ¥ç¶šãŒãªã„ãŸã‚ã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®åŒæœŸã¯ã§ãã¾ã›ã‚“ã€‚';
                submitButton.disabled = true;
                submitButton.textContent = 'è¨­å®šã‚¨ãƒ©ãƒ¼ (æŠ•ç¨¿ä¸å¯)';
                submitButton.classList.replace('bg-indigo-600', 'bg-gray-600');
                submitButton.classList.remove('hover:bg-indigo-700', 'hover:scale-[1.01]', 'cursor-pointer');
                isFirestoreReady = false;
                return;
            }
            
            // æ­£å¸¸ãªåˆæœŸåŒ–ã¨èªè¨¼
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app); 
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        const reviewsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
                        setupRealtimeListener(reviewsCollectionRef, user.uid); // UIDã‚’æ¸¡ã—ã¦ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’å¼·åŒ–
                        isFirestoreReady = true;
                        
                        // æº–å‚™å®Œäº†å¾Œã€æŠ•ç¨¿ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                        submitButton.disabled = false;
                        submitButton.textContent = 'ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿';
                        submitButton.classList.replace('bg-gray-600', 'bg-indigo-600');
                        submitButton.classList.add('hover:bg-indigo-700', 'hover:scale-[1.01]', 'cursor-pointer');

                    } else {
                        // èªè¨¼å¤±æ•—
                        userInfoDisplay.textContent = 'ã‚¨ãƒ©ãƒ¼: èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿åŒæœŸã¯ã§ãã¾ã›ã‚“ã€‚';
                        submitButton.disabled = true;
                        submitButton.textContent = 'èªè¨¼å¤±æ•— - æŠ•ç¨¿ä¸å¯'; 
                        submitButton.classList.replace('bg-indigo-600', 'bg-gray-600');
                        submitButton.classList.remove('hover:bg-indigo-700', 'hover:scale-[1.01]', 'cursor-pointer');
                        isFirestoreReady = false;
                    }
                });

            } catch (error) {
                // åˆæœŸåŒ–ã¾ãŸã¯èªè¨¼ãƒ—ãƒ­ã‚»ã‚¹ã§ã®ã‚¨ãƒ©ãƒ¼
                console.error("Firebase Initialization/Authentication Error:", error);
                userInfoDisplay.className = 'text-red-400 font-bold mt-2 p-2 bg-red-900 bg-opacity-30 rounded-lg';
                userInfoDisplay.textContent = `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message} ãƒ‡ãƒ¼ã‚¿åŒæœŸã¯ã§ãã¾ã›ã‚“ã€‚`;
                submitButton.disabled = true;
                submitButton.textContent = 'åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼ - æŠ•ç¨¿ä¸å¯'; 
                submitButton.classList.replace('bg-indigo-600', 'bg-gray-600');
                submitButton.classList.remove('hover:bg-indigo-700', 'hover:scale-[1.01]', 'cursor-pointer');
                isFirestoreReady = false;
            }
        }

        /**
         * Firestoreã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã™ã‚‹
         */
        function setupRealtimeListener(reviewsCollectionRef, userId) {
            
            const reviewsQuery = query(reviewsCollectionRef);
            
            onSnapshot(reviewsQuery, (snapshot) => {
                allReviewsData = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const timestamp = data.timestamp ? (data.timestamp.seconds * 1000) : Date.now();
                    return {
                        id: doc.id,
                        title: data.title,
                        artist: data.artist,
                        base64Image: data.base64Image || null,
                        rating: data.rating,
                        reviewText: data.reviewText,
                        timestamp: timestamp,
                    };
                });
                
                renderReviews(); 
                userInfoDisplay.className = 'text-green-400 mt-2';
                userInfoDisplay.textContent = `åŒæœŸå®Œäº† (User ID: ${userId})ï¼šãƒ‡ãƒ¼ã‚¿ã¯ã™ã¹ã¦ã®ãƒ‡ãƒã‚¤ã‚¹ã§å…±æœ‰ã•ã‚Œã¾ã™ã€‚`;
                showMessage('ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒåŒæœŸã•ã‚Œã¾ã—ãŸã€‚', 'bg-blue-900 text-blue-300');
            }, (error) => {
                console.error("Firestore real-time listener error:", error);
                showMessage('ãƒ‡ãƒ¼ã‚¿ã®åŒæœŸä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', 'bg-red-900 text-red-300');
            });
        }


        // ==========================================================
        // ãƒ‡ãƒ¼ã‚¿å‡¦ç†ãƒ˜ãƒ«ãƒ‘ãƒ¼
        // ==========================================================

        /**
         * ãƒ•ã‚¡ã‚¤ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’Base64æ–‡å­—åˆ—ã«å¤‰æ›ã™ã‚‹ï¼ˆéåŒæœŸï¼‰
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    resolve(null);
                    return;
                }
                if (file.size > 500 * 1024) { 
                    showMessage('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤§ãã™ãã¾ã™ï¼ˆ500KBä»¥ä¸‹æ¨å¥¨ï¼‰ã€‚ç”»åƒã‚’æ·»ä»˜ã›ãšã«æŠ•ç¨¿ã—ã¾ã™ã€‚', 'bg-yellow-900 text-yellow-300');
                    resolve(null);
                    return;
                }
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        /**
         * è©•ä¾¡ï¼ˆ1ã€œ5ï¼‰ã‚’æ˜Ÿã®æ–‡å­—åˆ—ã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
         */
        function renderStars(rating) {
            const fullStar = 'â˜…';
            const emptyStar = 'â˜†';
            const numFull = Math.max(0, Math.min(5, Math.round(rating)));
            const numEmpty = 5 - numFull;
            
            const fullStarHtml = `<span class="text-yellow-400">${fullStar.repeat(numFull)}</span>`;
            const emptyStarHtml = `<span class="text-gray-600">${emptyStar.repeat(numEmpty)}</span>`;

            return fullStarHtml + emptyStarHtml;
        }


        // ==========================================================
        // DOMæ“ä½œã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
        // ==========================================================

        /**
         * ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚«ãƒ¼ãƒ‰ã®HTMLã‚’ä½œæˆã™ã‚‹
         */
        function createReviewCard(review) {
            const timestamp = new Date(review.timestamp).toLocaleDateString('ja-JP', {
                year: 'numeric', month: 'numeric', day: 'numeric'
            });

            const imageUrl = review.base64Image || FALLBACK_IMAGE_URL;

            return `
                <div class="review-card bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700 hover:border-indigo-500 transition-all duration-300 ease-in-out" data-id="${review.id}">
                    <div class="review-content" data-id="${review.id}">
                        <div class="flex items-start mb-3 space-x-4">
                            <!-- ã‚¢ãƒ«ãƒãƒ ã‚«ãƒãƒ¼ç”»åƒ -->
                            <img src="${imageUrl}" alt="${review.title} Cover" 
                                 class="w-20 h-20 object-cover rounded-lg flex-shrink-0"
                                 onerror="this.onerror=null; this.src='${FALLBACK_IMAGE_URL}';"
                            >
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="text-xl font-bold text-indigo-400">${review.title}</h3>
                                        <p class="text-md text-gray-300">by ${review.artist}</p>
                                    </div>
                                    <div class="text-right flex-shrink-0 ml-4">
                                        <div class="text-2xl">${renderStars(review.rating)}</div>
                                        <p class="text-xs text-gray-500 mt-1">${timestamp}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p class="review-text text-gray-400 whitespace-pre-wrap leading-relaxed mt-2">${review.reviewText}</p>
                    </div>

                    <div class="review-actions mt-4 flex justify-end space-x-3">
                        <button class="edit-btn py-1 px-3 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-lg transition" data-id="${review.id}">
                            ç·¨é›†
                        </button>
                        <button class="delete-btn py-1 px-3 text-red-400 hover:text-red-500 text-sm font-medium rounded-lg transition" data-id="${review.id}">
                            å‰Šé™¤
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * å…¨ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”»é¢ã«æç”»ã™ã‚‹
         */
        function renderReviews() {
            // JSã§ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®é™é †ã§ã‚½ãƒ¼ãƒˆ
            const sortedReviews = [...allReviewsData].sort((a, b) => b.timestamp - a.timestamp); 
            
            const searchTerm = searchArtistInput.value.toLowerCase().trim();
            
            const filteredReviews = sortedReviews.filter(review => {
                if (!searchTerm) return true; 
                return review.artist.toLowerCase().includes(searchTerm);
            });

            reviewsList.innerHTML = '';

            if (filteredReviews.length === 0) {
                noReviewsMessage.textContent = searchTerm 
                    ? `ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã€Œ${searchTerm}ã€ã«ä¸€è‡´ã™ã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`
                    : 'ã¾ã ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›¸ã„ã¦ã¿ã¾ã—ã‚‡ã†ï¼';
                    
                noReviewsMessage.classList.remove('hidden');
                return;
            } else {
                noReviewsMessage.classList.add('hidden');
            }

            const reviewHtml = filteredReviews.map(createReviewCard).join('');
            reviewsList.innerHTML = reviewHtml;

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
            reviewsList.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', handleDelete);
            });
            reviewsList.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', handleEditClick);
            });
        }
        
        /**
         * ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆã‚’å‡¦ç†ã™ã‚‹
         */
        function handleEditClick(event) {
            if (!isFirestoreReady) return showMessage('ãƒ‡ãƒ¼ã‚¿æ¥ç¶šãŒã§ãã¦ã„ãªã„ãŸã‚ã€ç·¨é›†ã§ãã¾ã›ã‚“ã€‚', 'bg-red-900 text-red-300');

            const reviewId = event.target.dataset.id;
            const reviewCard = event.target.closest('.review-card');
            const review = allReviewsData.find(r => r.id === reviewId);
            
            if (!review) return;

            // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®HTMLã‚’ç”Ÿæˆ
            const editFormHtml = `
                <form class="edit-form space-y-4 pt-4 border-t border-gray-700" data-id="${review.id}">
                    <h3 class="text-xl font-bold text-indigo-300">ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ç·¨é›†</h3>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">ã‚¢ãƒ«ãƒãƒ å</label>
                        <input type="text" name="title" value="${review.title}" required 
                               class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆå</label>
                        <input type="text" name="artist" value="${review.artist}" required 
                               class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    
                    <div class="flex space-x-4 items-center">
                        <img src="${review.base64Image || FALLBACK_IMAGE_URL}" alt="Current Cover" class="w-16 h-16 object-cover rounded-lg flex-shrink-0">
                        <div class="flex-grow">
                            <label class="block text-sm font-medium text-gray-300 mb-1">æ–°ã—ã„ã‚«ãƒãƒ¼ç”»åƒ (å¤‰æ›´ã™ã‚‹å ´åˆã®ã¿)</label>
                            <input type="file" name="imageFile" accept="image/*"
                                   class="w-full file:mr-4 file:py-1 file:px-2 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-indigo-500 file:text-white hover:file:bg-indigo-600 p-1 bg-gray-700 border border-gray-600 rounded-lg text-gray-300">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">è©•ä¾¡ (1ã€œ5)</label>
                        <input type="number" name="rating" value="${review.rating}" min="1" max="5" required 
                               class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ¬æ–‡</label>
                        <textarea name="reviewText" rows="4" required 
                                  class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">${review.reviewText}</textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" class="cancel-edit-btn py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                        <button type="submit" class="save-edit-btn py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition">ä¿å­˜</button>
                    </div>
                </form>
            `;
            
            reviewCard.innerHTML = editFormHtml;
            
            const editForm = reviewCard.querySelector('.edit-form');
            editForm.addEventListener('submit', handleSaveEdit);
            reviewCard.querySelector('.cancel-edit-btn').addEventListener('click', renderReviews);
        }

        /**
         * ç·¨é›†å†…å®¹ã®ä¿å­˜ã‚’å‡¦ç†ã™ã‚‹
         */
        async function handleSaveEdit(event) {
            event.preventDefault();

            // ğŸš¨ å¼·åŒ–ã•ã‚ŒãŸãƒã‚§ãƒƒã‚¯
            if (!isFirestoreReady || !db) {
                console.error("Database not ready for update.");
                return showMessage('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼: æ¥ç¶šæº–å‚™ãŒã§ãã¦ã„ã¾ã›ã‚“ã€‚', 'bg-red-900 text-red-300');
            }

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // å†…éƒ¨ã§å†å–å¾—
            const reviewId = event.target.dataset.id;
            const reviewDocRef = doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, reviewId);
            
            const formElements = event.target.elements;
            const newTitle = formElements.title.value.trim();
            const newArtist = formElements.artist.value.trim();
            const newRating = parseFloat(formElements.rating.value);
            const newReviewText = formElements.reviewText.value.trim();
            const newImageFile = formElements.imageFile.files[0];

            if (!newTitle || !newArtist || !newRating || !newReviewText || newRating < 1 || newRating > 5) {
                showMessage('å…¨ã¦ã®å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'bg-red-900 text-red-300');
                return;
            }
            
            const base64Image = newImageFile 
                ? await fileToBase64(newImageFile) 
                : allReviewsData.find(r => r.id === reviewId)?.base64Image;

            const updateData = {
                title: newTitle,
                artist: newArtist,
                rating: newRating,
                reviewText: newReviewText,
                base64Image: base64Image || null,
                timestamp: serverTimestamp() 
            };

            try {
                await updateDoc(reviewDocRef, updateData);
                showMessage('ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒæ­£å¸¸ã«æ›´æ–°ã•ã‚Œã¾ã—ãŸï¼', 'bg-green-900 text-green-300');
            } catch (error) {
                console.error("Error updating document:", error);
                showMessage(`ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'bg-red-900 text-red-300');
            }
        }

        /**
         * ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡ã‚’å‡¦ç†ã™ã‚‹ (æ–°è¦æŠ•ç¨¿)
         */
        async function handleFormSubmit(event) {
            event.preventDefault();

            // ğŸš¨ å¼·åŒ–ã•ã‚ŒãŸãƒã‚§ãƒƒã‚¯
            if (!isFirestoreReady || !db) {
                console.error("Database not ready for submit.");
                return showMessage('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼: æ¥ç¶šæº–å‚™ãŒã§ãã¦ã„ã¾ã›ã‚“ã€‚', 'bg-red-900 text-red-300');
            }
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // å†…éƒ¨ã§å†å–å¾—
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
            const title = document.getElementById('album-title').value.trim();
            const artist = document.getElementById('artist-name').value.trim();
            const rating = parseFloat(document.getElementById('rating').value);
            const reviewText = document.getElementById('review-text').value.trim();
            const imageFile = albumImageFileInput.files[0];

            if (!title || !artist || !rating || !reviewText) {
                showMessage('å…¨ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'bg-red-900 text-red-300');
                return;
            }
            if (rating < 1 || rating > 5) {
                showMessage('è©•ä¾¡ã¯1ã‹ã‚‰5ã®é–“ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'bg-red-900 text-red-300');
                return;
            }

            const base64Image = await fileToBase64(imageFile);

            const newReview = {
                title,
                artist,
                base64Image: base64Image || null,
                rating,
                reviewText,
                timestamp: serverTimestamp() 
            };

            try {
                // æŠ•ç¨¿å‡¦ç†ä¸­ã¯ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ã—ã€äºŒé‡æŠ•ç¨¿ã‚’é˜²ã
                submitButton.disabled = true;
                submitButton.textContent = 'æŠ•ç¨¿ä¸­...';

                await addDoc(collectionRef, newReview);
                
                form.reset();
                showMessage('ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒæ­£å¸¸ã«æŠ•ç¨¿ã•ã‚Œã¾ã—ãŸï¼', 'bg-green-900 text-green-300');

            } catch (error) {
                console.error("Error adding document:", error);
                showMessage(`ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'bg-red-900 text-red-300');
            } finally {
                // å‡¦ç†å®Œäº†å¾Œã€ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™ (isFirestoreReadyãŒtrueã§ã‚ã‚‹ã“ã¨ã‚’å‰æ)
                if (isFirestoreReady) {
                    submitButton.disabled = false;
                    submitButton.textContent = 'ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿';
                }
            }
        }

        /**
         * ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å‰Šé™¤ã‚’å‡¦ç†ã™ã‚‹
         */
        function handleDelete(event) {
            if (!isFirestoreReady || !db) {
                console.error("Database not ready for delete.");
                return showMessage('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼: æ¥ç¶šæº–å‚™ãŒã§ãã¦ã„ã¾ã›ã‚“ã€‚', 'bg-red-900 text-red-300');
            }

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // å†…éƒ¨ã§å†å–å¾—
            const reviewId = event.target.dataset.id;
            
            showCustomModal("ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ", async () => {
                try {
                    const reviewDocRef = doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, reviewId);
                    await deleteDoc(reviewDocRef);
                    showMessage('ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚', 'bg-red-900 text-red-300');
                } catch (error) {
                    console.error("Error deleting document:", error);
                    showMessage(`ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`, 'bg-red-900 text-red-300');
                }
            });
        }
        
        /**
         * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã‚’è¡¨ç¤ºã™ã‚‹
         */
        function showMessage(message, classes) {
            messageBox.textContent = message;
            messageBox.className = `mt-4 p-3 rounded-lg text-center ${classes}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000); 
        }
        
        // ==========================================================
        // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆalertã‚„confirmã®ä»£æ›¿ï¼‰
        // ==========================================================
        
        let modalElement = null;
        
        function createCustomModal() {
            const container = document.getElementById('custom-modal-container');
            if (container.querySelector('#custom-modal')) {
                modalElement = container.querySelector('#custom-modal');
                return;
            }

            const modalHtml = `
                <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden transition-opacity duration-300">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-2xl max-w-sm w-full transform scale-95 transition-transform duration-300">
                        <p id="modal-text" class="text-lg mb-6 text-gray-200"></p>
                        <div class="flex justify-end space-x-3">
                            <button id="modal-cancel" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                            <button id="modal-confirm" class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition">å‰Šé™¤</button>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML = modalHtml;
            modalElement = container.querySelector('#custom-modal');
        }

        function showCustomModal(message, onConfirm) {
            if (!modalElement) createCustomModal();
            
            const modal = modalElement;
            document.getElementById('modal-text').textContent = message;

            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');

            const handleConfirm = () => {
                onConfirm();
                modal.classList.add('hidden');
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };

            const handleCancel = () => {
                modal.classList.add('hidden');
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };

            confirmBtn.onclick = null;
            cancelBtn.onclick = null;
            
            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);

            modal.classList.remove('hidden');
        }


        // ==========================================================
        // åˆæœŸåŒ–å‡¦ç†
        // ==========================================================
        
        // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        form.addEventListener('submit', handleFormSubmit);

        // æ¤œç´¢å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        searchArtistInput.addEventListener('input', renderReviews);

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            createCustomModal(); 
            initializeFirebase();
        });

    </script>
</body>
</html>
