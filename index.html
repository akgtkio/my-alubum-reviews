<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>お気に入りアルバムレビューサイト</title>
    <!-- Tailwind CSS CDNを読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- フォント設定 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+JP:wght@100..900&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight text-indigo-400">
                マイ・アルバム・レビュー
            </h1>
            <p class="text-gray-400 mt-2">ゆるく更新する、あなただけの音楽コレクション</p>
        </header>

        <!-- 新しいレビュー投稿フォーム -->
        <section id="review-form" class="bg-gray-800 p-6 rounded-xl shadow-2xl mb-12 border border-gray-700">
            <h2 class="text-2xl font-bold mb-5 text-indigo-300">新しいレビューを追加</h2>
            <form id="album-review-form" class="space-y-4">
                <div>
                    <label for="album-title" class="block text-sm font-medium text-gray-300 mb-1">アルバム名</label>
                    <input type="text" id="album-title" required 
                           class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 transition">
                </div>
                <div>
                    <label for="artist-name" class="block text-sm font-medium text-gray-300 mb-1">アーティスト名</label>
                    <input type="text" id="artist-name" required 
                           class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 transition">
                </div>
                <!-- UPDATED: カバー画像URL入力欄からファイルアップロードに変更 -->
                <div>
                    <label for="album-image-file" class="block text-sm font-medium text-gray-300 mb-1">カバー画像ファイル (任意)</label>
                    <input type="file" id="album-image-file" accept="image/*"
                           class="w-full file:mr-4 file:py-2 file:px-4
                                  file:rounded-lg file:border-0
                                  file:text-sm file:font-semibold
                                  file:bg-indigo-500 file:text-white
                                  hover:file:bg-indigo-600
                                  p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-300 transition">
                    <p class="text-xs text-gray-500 mt-1">※ローカルストレージ容量制限のため、小さな画像推奨</p>
                </div>
                <div>
                    <label for="rating" class="block text-sm font-medium text-gray-300 mb-1">評価 (1〜5)</label>
                    <input type="number" id="rating" min="1" max="5" required 
                           class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 transition">
                </div>
                <div>
                    <label for="review-text" class="block text-sm font-medium text-gray-300 mb-1">レビュー本文</label>
                    <textarea id="review-text" rows="4" required 
                              class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 transition"></textarea>
                </div>
                <button type="submit" 
                        class="w-full py-3 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg shadow-md transition transform hover:scale-[1.01] focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-900">
                    レビューを投稿
                </button>
            </form>
            <div id="message-box" class="mt-4 p-3 rounded-lg text-center hidden"></div>
        </section>

        <!-- レビュー一覧表示エリア -->
        <section id="review-list-container">
            <h2 class="text-2xl font-bold mb-6 text-indigo-300 border-b border-gray-700 pb-2">レビュー一覧</h2>

            <!-- 検索入力フィールド -->
            <div class="mb-6">
                <label for="search-artist" class="block text-sm font-medium text-gray-300 mb-1">アーティスト名で検索</label>
                <input type="text" id="search-artist" placeholder="アーティスト名を入力..."
                       class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 transition">
            </div>

            <div id="reviews-list" class="space-y-6">
                <!-- レビューカードがここに挿入されます -->
            </div>
            <p id="no-reviews-message" class="text-center text-gray-500 mt-8 hidden">
                まだレビューがありません。最初のレビューを書いてみましょう！
            </p>
        </section>
    </div>

    <script>
        // グローバル定数
        const STORAGE_KEY = 'albumReviews';
        const FALLBACK_IMAGE_URL = 'https://placehold.co/100x100/374151/E5E7EB?text=Cover';

        // DOM要素の参照
        const form = document.getElementById('album-review-form');
        const reviewsList = document.getElementById('reviews-list');
        const noReviewsMessage = document.getElementById('no-reviews-message');
        const messageBox = document.getElementById('message-box');
        // UPDATED: 画像ファイル入力への参照
        const albumImageFileInput = document.getElementById('album-image-file');
        const searchArtistInput = document.getElementById('search-artist');

        /**
         * ファイルオブジェクトをBase64文字列に変換する（非同期）
         * @param {File} file - Fileオブジェクト
         * @returns {Promise<string|null>} Base64文字列 (data URL) または null
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    resolve(null);
                    return;
                }
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        /**
         * localStorageからレビューデータを取得する
         * @returns {Array} レビューオブジェクトの配列
         */
        function getReviews() {
            try {
                const storedReviews = localStorage.getItem(STORAGE_KEY);
                // 以前のバージョンでimageUrlを使っていた場合のために、base64Imageとして統合
                let reviews = storedReviews ? JSON.parse(storedReviews) : [];
                return reviews.map(review => ({
                    ...review,
                    // imageUrlがあればbase64Imageとして使う（互換性維持）
                    base64Image: review.base64Image || review.imageUrl || null
                }));
            } catch (error) {
                console.error('レビューのロード中にエラーが発生しました:', error);
                return [];
            }
        }

        /**
         * レビューデータをlocalStorageに保存する
         * @param {Array} reviews - 保存するレビューオブジェクトの配列
         */
        function saveReviews(reviews) {
            try {
                // imageUrlは古いフィールドなので、保存時には除去してbase64Imageのみにする
                const reviewsToSave = reviews.map(({ imageUrl, ...rest }) => rest);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(reviewsToSave));
            } catch (error) {
                // ローカルストレージが容量オーバーの場合のエラー処理
                if (error.name === 'QuotaExceededError') {
                    console.error('ローカルストレージの容量を超過しました。画像を減らしてください。');
                    showMessage('エラー: ローカルストレージの容量がいっぱいです。画像を減らしてください。', 'bg-red-900 text-red-300');
                } else {
                    console.error('レビューの保存中にエラーが発生しました:', error);
                }
            }
        }

        /**
         * 評価（1〜5）を星の文字列に変換するヘルパー関数
         */
        function renderStars(rating) {
            const fullStar = '★';
            const emptyStar = '☆';
            const numFull = Math.max(0, Math.min(5, Math.round(rating)));
            const numEmpty = 5 - numFull;
            
            const fullStarHtml = `<span class="text-yellow-400">${fullStar.repeat(numFull)}</span>`;
            const emptyStarHtml = `<span class="text-gray-600">${emptyStar.repeat(numEmpty)}</span>`;

            return fullStarHtml + emptyStarHtml;
        }

        /**
         * レビューカードのHTMLを作成する
         */
        function createReviewCard(review) {
            const timestamp = new Date(review.timestamp).toLocaleDateString('ja-JP', {
                year: 'numeric', month: 'numeric', day: 'numeric'
            });

            // Base64画像またはフォールバック画像URLを使用
            const imageUrl = review.base64Image || FALLBACK_IMAGE_URL;

            return `
                <div class="review-card bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700 hover:border-indigo-500 transition-all duration-300 ease-in-out" data-id="${review.id}">
                    <div class="review-content" data-id="${review.id}">
                        <div class="flex items-start mb-3 space-x-4">
                            <!-- アルバムカバー画像 -->
                            <img src="${imageUrl}" alt="${review.title} Cover" 
                                 class="w-20 h-20 object-cover rounded-lg flex-shrink-0"
                                 onerror="this.onerror=null; this.src='${FALLBACK_IMAGE_URL}';"
                            >
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="text-xl font-bold text-indigo-400">${review.title}</h3>
                                        <p class="text-md text-gray-300">by ${review.artist}</p>
                                    </div>
                                    <div class="text-right flex-shrink-0 ml-4">
                                        <div class="text-2xl">${renderStars(review.rating)}</div>
                                        <p class="text-xs text-gray-500 mt-1">${timestamp}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p class="review-text text-gray-400 whitespace-pre-wrap leading-relaxed mt-2">${review.reviewText}</p>
                    </div>

                    <div class="review-actions mt-4 flex justify-end space-x-3">
                        <!-- NEW: 編集ボタン -->
                        <button class="edit-btn py-1 px-3 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-lg transition" data-id="${review.id}">
                            編集
                        </button>
                        <button class="delete-btn py-1 px-3 text-red-400 hover:text-red-500 text-sm font-medium rounded-lg transition" data-id="${review.id}">
                            削除
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * 全レビューを画面に描画する
         */
        function renderReviews() {
            const allReviews = getReviews().sort((a, b) => b.timestamp - a.timestamp); // 新しいものを上に
            
            const searchTerm = searchArtistInput.value.toLowerCase().trim();
            
            const filteredReviews = allReviews.filter(review => {
                if (!searchTerm) return true; // 検索語がない場合は全て表示
                return review.artist.toLowerCase().includes(searchTerm);
            });

            reviewsList.innerHTML = '';

            if (filteredReviews.length === 0) {
                noReviewsMessage.textContent = searchTerm 
                    ? `アーティスト名「${searchTerm}」に一致するレビューはありません。`
                    : 'まだレビューがありません。最初のレビューを書いてみましょう！';
                    
                noReviewsMessage.classList.remove('hidden');
                return;
            } else {
                noReviewsMessage.classList.add('hidden');
            }

            const reviewHtml = filteredReviews.map(createReviewCard).join('');
            reviewsList.innerHTML = reviewHtml;

            // イベントリスナーの設定
            reviewsList.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', handleDelete);
            });
            reviewsList.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', handleEditClick);
            });
        }
        
        /**
         * 編集モードの切り替えを処理する
         */
        function handleEditClick(event) {
            const reviewId = parseInt(event.target.dataset.id);
            const reviewCard = event.target.closest('.review-card');
            const review = getReviews().find(r => r.id === reviewId);
            
            if (!review) return;

            // 編集フォームのHTMLを生成
            const editFormHtml = `
                <form class="edit-form space-y-4 pt-4 border-t border-gray-700" data-id="${review.id}">
                    <h3 class="text-xl font-bold text-indigo-300">レビューの編集</h3>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">アルバム名</label>
                        <input type="text" name="title" value="${review.title}" required 
                               class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">アーティスト名</label>
                        <input type="text" name="artist" value="${review.artist}" required 
                               class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    
                    <div class="flex space-x-4 items-center">
                        <img src="${review.base64Image || FALLBACK_IMAGE_URL}" alt="Current Cover" class="w-16 h-16 object-cover rounded-lg flex-shrink-0">
                        <div class="flex-grow">
                            <label class="block text-sm font-medium text-gray-300 mb-1">新しいカバー画像 (変更する場合のみ)</label>
                            <input type="file" name="imageFile" accept="image/*"
                                   class="w-full file:mr-4 file:py-1 file:px-2 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-indigo-500 file:text-white hover:file:bg-indigo-600 p-1 bg-gray-700 border border-gray-600 rounded-lg text-gray-300">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">評価 (1〜5)</label>
                        <input type="number" name="rating" value="${review.rating}" min="1" max="5" required 
                               class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">レビュー本文</label>
                        <textarea name="reviewText" rows="4" required 
                                  class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">${review.reviewText}</textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" class="cancel-edit-btn py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition">キャンセル</button>
                        <button type="submit" class="save-edit-btn py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition">保存</button>
                    </div>
                </form>
            `;
            
            // カードの内容を編集フォームに置き換え
            reviewCard.innerHTML = editFormHtml;
            
            // イベントリスナーを設定
            const editForm = reviewCard.querySelector('.edit-form');
            editForm.addEventListener('submit', handleSaveEdit);
            reviewCard.querySelector('.cancel-edit-btn').addEventListener('click', renderReviews);
        }

        /**
         * 編集内容の保存を処理する
         */
        async function handleSaveEdit(event) {
            event.preventDefault();

            const reviewId = parseInt(event.target.dataset.id);
            const currentReviews = getReviews();
            const reviewIndex = currentReviews.findIndex(r => r.id === reviewId);
            
            if (reviewIndex === -1) return;

            const formElements = event.target.elements;
            const newTitle = formElements.title.value.trim();
            const newArtist = formElements.artist.value.trim();
            const newRating = parseFloat(formElements.rating.value);
            const newReviewText = formElements.reviewText.value.trim();
            const newImageFile = formElements.imageFile.files[0];

            if (!newTitle || !newArtist || !newRating || !newReviewText || newRating < 1 || newRating > 5) {
                showMessage('全ての必須フィールドを正しく入力してください。', 'bg-red-900 text-red-300');
                return;
            }

            // 画像ファイルのBase64変換を待つ
            const base64Image = newImageFile 
                ? await fileToBase64(newImageFile) 
                : currentReviews[reviewIndex].base64Image; // ファイルが選択されていない場合は既存の画像を維持

            currentReviews[reviewIndex] = {
                ...currentReviews[reviewIndex],
                title: newTitle,
                artist: newArtist,
                rating: newRating,
                reviewText: newReviewText,
                base64Image: base64Image, // 新しいBase64画像を保存
                timestamp: Date.now() // 最終更新日時を更新
            };

            saveReviews(currentReviews);
            renderReviews(); // 再描画して通常表示に戻す
            showMessage('レビューが正常に更新されました！', 'bg-green-900 text-green-300');
        }

        /**
         * フォームの送信を処理する (新規投稿)
         */
        async function handleFormSubmit(event) {
            event.preventDefault();

            const title = document.getElementById('album-title').value.trim();
            const artist = document.getElementById('artist-name').value.trim();
            const rating = parseFloat(document.getElementById('rating').value);
            const reviewText = document.getElementById('review-text').value.trim();
            const imageFile = albumImageFileInput.files[0];

            if (!title || !artist || !rating || !reviewText) {
                showMessage('全てのフィールドを入力してください。', 'bg-red-900 text-red-300');
                return;
            }
            if (rating < 1 || rating > 5) {
                showMessage('評価は1から5の間で入力してください。', 'bg-red-900 text-red-300');
                return;
            }

            // 画像ファイルをBase64に変換（非同期処理）
            const base64Image = await fileToBase64(imageFile);

            const newReview = {
                id: Date.now(), // 一意なIDとしてタイムスタンプを使用
                title,
                artist,
                base64Image, // Base64画像を保存
                rating,
                reviewText,
                timestamp: Date.now()
            };

            const reviews = getReviews();
            reviews.push(newReview);
            saveReviews(reviews);

            // フォームをリセット
            form.reset();
            
            // レビュー一覧を更新
            renderReviews();
            
            showMessage('レビューが正常に投稿されました！', 'bg-green-900 text-green-300');
        }

        /**
         * レビューの削除を処理する
         */
        function handleDelete(event) {
            const reviewId = parseInt(event.target.dataset.id);
            
            // カスタムモーダルメッセージを表示
            showCustomModal("レビューを削除しますか？", () => {
                let reviews = getReviews();
                reviews = reviews.filter(review => review.id !== reviewId);
                saveReviews(reviews);
                renderReviews();
                showMessage('レビューが削除されました。', 'bg-red-900 text-red-300');
            });
        }
        
        /**
         * メッセージボックスを表示する
         */
        function showMessage(message, classes) {
            messageBox.textContent = message;
            messageBox.className = `mt-4 p-3 rounded-lg text-center ${classes}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000); // 3秒後に非表示
        }
        
        // ==========================================================
        // カスタムモーダル（alertやconfirmの代替）
        // ==========================================================
        
        let modalElement = null;
        
        function createCustomModal() {
            if (modalElement) return modalElement;

            const modalHtml = `
                <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden transition-opacity duration-300">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-2xl max-w-sm w-full transform scale-95 transition-transform duration-300">
                        <p id="modal-text" class="text-lg mb-6 text-gray-200"></p>
                        <div class="flex justify-end space-x-3">
                            <button id="modal-cancel" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition">キャンセル</button>
                            <button id="modal-confirm" class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition">削除</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            modalElement = document.getElementById('custom-modal');
            return modalElement;
        }

        function showCustomModal(message, onConfirm) {
            const modal = createCustomModal();
            document.getElementById('modal-text').textContent = message;

            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');

            // クリーンアップ
            const confirmClone = confirmBtn.cloneNode(true);
            const cancelClone = cancelBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(confirmClone, confirmBtn);
            cancelBtn.parentNode.replaceChild(cancelClone, cancelBtn);

            // イベントリスナーの再設定
            confirmClone.addEventListener('click', () => {
                onConfirm();
                modal.classList.add('hidden');
            });

            cancelClone.addEventListener('click', () => {
                modal.classList.add('hidden');
            });

            // 表示
            modal.classList.remove('hidden');
        }


        // ==========================================================
        // 初期化処理
        // ==========================================================
        
        // フォーム送信イベントリスナー
        form.addEventListener('submit', handleFormSubmit);

        // 検索入力イベントリスナー
        searchArtistInput.addEventListener('input', renderReviews);

        // ページロード時にレビュー一覧を描画
        document.addEventListener('DOMContentLoaded', () => {
            renderReviews();
            createCustomModal(); // モーダル要素を事前に作成
        });

    </script>
</body>
</html>
