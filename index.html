<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>お気に入りアルバムレビューサイト</title>
    <!-- Tailwind CSS CDNを読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- フォント設定 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+JP:wght@100..900&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight text-indigo-400">
                マイ・アルバム・レビュー
            </h1>
            <!-- ユーザー同期ステータス表示エリア -->
            <p id="user-info" class="text-gray-400 mt-2">Firebase設定をチェック中...</p>
        </header>

        <!-- 新しいレビュー投稿フォーム -->
        <section id="review-form" class="bg-gray-800 p-6 rounded-xl shadow-2xl mb-12 border border-gray-700">
            <h2 class="text-2xl font-bold mb-5 reorganize_text_to_be_more_dynamic_than_a_bullet_pointtext-indigo-300">新しいレビューを追加</h2>
            <form id="album-review-form" class="space-y-4">
                <div>
                    <label for="album-title" class="block text-sm font-medium text-gray-300 mb-1">アルバム名</label>
                    <input type="text" id="album-title" required 
                           class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 transition">
                </div>
                <div>
                    <label for="artist-name" class="block text-sm font-medium text-gray-300 mb-1">アーティスト名</label>
                    <input type="text" id="artist-name" required 
                           class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 transition">
                </div>
                <div>
                    <label for="album-image-file" class="block text-sm font-medium text-gray-300 mb-1">カバー画像ファイル (任意)</label>
                    <input type="file" id="album-image-file" accept="image/*"
                           class="w-full file:mr-4 file:py-2 file:px-4
                                  file:rounded-lg file:border-0
                                  file:text-sm file:font-semibold
                                  file:bg-indigo-500 file:text-white
                                  hover:file:bg-indigo-600
                                  p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-300 transition">
                    <p class="text-xs text-gray-500 mt-1">※Base64で保存されます</p>
                </div>
                <div>
                    <label for="rating" class="block text-sm font-medium text-gray-300 mb-1">評価 (1〜5)</label>
                    <input type="number" id="rating" min="1" max="5" required 
                           class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 transition">
                </div>
                <div>
                    <label for="review-text" class="block text-sm font-medium text-gray-300 mb-1">レビュー本文</label>
                    <textarea id="review-text" rows="4" required 
                              class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 transition"></textarea>
                </div>
                <button type="submit" id="submit-button" disabled
                        class="w-full py-3 px-4 bg-gray-600 text-white font-semibold rounded-lg shadow-md transition transform focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-gray-900 disabled:opacity-50 cursor-not-allowed">
                    接続中...
                </button>
            </form>
            <div id="message-box" class="mt-4 p-3 rounded-lg text-center hidden"></div>
        </section>

        <!-- レビュー一覧表示エリア -->
        <section id="review-list-container">
            <h2 class="text-2xl font-bold mb-6 text-indigo-300 border-b border-gray-700 pb-2">レビュー一覧</h2>

            <!-- 検索入力フィールド -->
            <div class="mb-6">
                <label for="search-artist" class="block text-sm font-medium text-gray-300 mb-1">アーティスト名で検索</label>
                <input type="text" id="search-artist" placeholder="アーティスト名を入力..."
                       class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 transition">
            </div>

            <div id="reviews-list" class="space-y-6">
                <!-- レビューカードがここに挿入されます -->
            </div>
            <p id="no-reviews-message" class="text-center text-gray-500 mt-8">
                Firebase設定をチェック中...
            </p>
        </section>
    </div>

    <!-- カスタムモーダルコンテナ (HTMLの最後に配置) -->
    <div id="custom-modal-container"></div>

    <!-- Firebase SDKの読み込み -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firestoreのログレベルを設定 (デバッグ用)
        setLogLevel('Debug');

        // グローバル変数
        let db = null;
        let allReviewsData = []; 
        let isFirestoreReady = false; 

        // DOM要素の参照
        const form = document.getElementById('album-review-form');
        const reviewsList = document.getElementById('reviews-list');
        const noReviewsMessage = document.getElementById('no-reviews-message');
        const messageBox = document.getElementById('message-box');
        const albumImageFileInput = document.getElementById('album-image-file');
        const searchArtistInput = document.getElementById('search-artist');
        const userInfoDisplay = document.getElementById('user-info');
        const submitButton = document.getElementById('submit-button');
        
        const COLLECTION_NAME = 'reviews';
        const FALLBACK_IMAGE_URL = 'https://placehold.co/100x100/374151/E5E7EB?text=Cover';

        // ==========================================================
        // Firebase初期化と認証
        // ==========================================================
        async function initializeFirebase() {
            // 必須のグローバル変数を取得し、未定義の場合はフォールバック
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            // JSON.parseが失敗する可能性があるため、try/catchで保護
            let firebaseConfig = {};
            try {
                firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            } catch (e) {
                console.error("Error parsing __firebase_config:", e);
                // firebaseConfigは空のまま
            }
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            const configIsMissing = Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId;

            if (configIsMissing) {
                // 🚨 設定情報不足のエラー処理
                console.error("致命的なエラー: Firebase Configurationが見つからないか、不完全です。");
                userInfoDisplay.className = 'text-red-400 font-bold mt-2 p-2 bg-red-900 bg-opacity-30 rounded-lg';
                userInfoDisplay.textContent = '【致命的な設定エラー】データ同期設定が見つかりません。投稿・編集はできません。';
                noReviewsMessage.textContent = 'データ接続がないため、レビューの同期はできません。';
                submitButton.disabled = true;
                submitButton.textContent = '設定エラー (投稿不可)';
                submitButton.classList.replace('bg-indigo-600', 'bg-gray-600');
                submitButton.classList.remove('hover:bg-indigo-700', 'hover:scale-[1.01]', 'cursor-pointer');
                isFirestoreReady = false;
                return;
            }
            
            // 正常な初期化と認証
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app); 
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        const reviewsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
                        setupRealtimeListener(reviewsCollectionRef, user.uid); // UIDを渡してデバッグ情報を強化
                        isFirestoreReady = true;
                        
                        // 準備完了後、投稿ボタンを有効化
                        submitButton.disabled = false;
                        submitButton.textContent = 'レビューを投稿';
                        submitButton.classList.replace('bg-gray-600', 'bg-indigo-600');
                        submitButton.classList.add('hover:bg-indigo-700', 'hover:scale-[1.01]', 'cursor-pointer');

                    } else {
                        // 認証失敗
                        userInfoDisplay.textContent = 'エラー: 認証に失敗しました。データ同期はできません。';
                        submitButton.disabled = true;
                        submitButton.textContent = '認証失敗 - 投稿不可'; 
                        submitButton.classList.replace('bg-indigo-600', 'bg-gray-600');
                        submitButton.classList.remove('hover:bg-indigo-700', 'hover:scale-[1.01]', 'cursor-pointer');
                        isFirestoreReady = false;
                    }
                });

            } catch (error) {
                // 初期化または認証プロセスでのエラー
                console.error("Firebase Initialization/Authentication Error:", error);
                userInfoDisplay.className = 'text-red-400 font-bold mt-2 p-2 bg-red-900 bg-opacity-30 rounded-lg';
                userInfoDisplay.textContent = `エラーが発生しました: ${error.message} データ同期はできません。`;
                submitButton.disabled = true;
                submitButton.textContent = '初期化エラー - 投稿不可'; 
                submitButton.classList.replace('bg-indigo-600', 'bg-gray-600');
                submitButton.classList.remove('hover:bg-indigo-700', 'hover:scale-[1.01]', 'cursor-pointer');
                isFirestoreReady = false;
            }
        }

        /**
         * Firestoreのリアルタイムリスナーを設定する
         */
        function setupRealtimeListener(reviewsCollectionRef, userId) {
            
            const reviewsQuery = query(reviewsCollectionRef);
            
            onSnapshot(reviewsQuery, (snapshot) => {
                allReviewsData = snapshot.docs.map(doc => {
                    const data = doc.data();
                    const timestamp = data.timestamp ? (data.timestamp.seconds * 1000) : Date.now();
                    return {
                        id: doc.id,
                        title: data.title,
                        artist: data.artist,
                        base64Image: data.base64Image || null,
                        rating: data.rating,
                        reviewText: data.reviewText,
                        timestamp: timestamp,
                    };
                });
                
                renderReviews(); 
                userInfoDisplay.className = 'text-green-400 mt-2';
                userInfoDisplay.textContent = `同期完了 (User ID: ${userId})：データはすべてのデバイスで共有されます。`;
                showMessage('レビューデータが同期されました。', 'bg-blue-900 text-blue-300');
            }, (error) => {
                console.error("Firestore real-time listener error:", error);
                showMessage('データの同期中にエラーが発生しました。', 'bg-red-900 text-red-300');
            });
        }


        // ==========================================================
        // データ処理ヘルパー
        // ==========================================================

        /**
         * ファイルオブジェクトをBase64文字列に変換する（非同期）
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                if (!file) {
                    resolve(null);
                    return;
                }
                if (file.size > 500 * 1024) { 
                    showMessage('画像ファイルが大きすぎます（500KB以下推奨）。画像を添付せずに投稿します。', 'bg-yellow-900 text-yellow-300');
                    resolve(null);
                    return;
                }
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        /**
         * 評価（1〜5）を星の文字列に変換するヘルパー関数
         */
        function renderStars(rating) {
            const fullStar = '★';
            const emptyStar = '☆';
            const numFull = Math.max(0, Math.min(5, Math.round(rating)));
            const numEmpty = 5 - numFull;
            
            const fullStarHtml = `<span class="text-yellow-400">${fullStar.repeat(numFull)}</span>`;
            const emptyStarHtml = `<span class="text-gray-600">${emptyStar.repeat(numEmpty)}</span>`;

            return fullStarHtml + emptyStarHtml;
        }


        // ==========================================================
        // DOM操作とイベントハンドラ
        // ==========================================================

        /**
         * レビューカードのHTMLを作成する
         */
        function createReviewCard(review) {
            const timestamp = new Date(review.timestamp).toLocaleDateString('ja-JP', {
                year: 'numeric', month: 'numeric', day: 'numeric'
            });

            const imageUrl = review.base64Image || FALLBACK_IMAGE_URL;

            return `
                <div class="review-card bg-gray-800 p-5 rounded-xl shadow-lg border border-gray-700 hover:border-indigo-500 transition-all duration-300 ease-in-out" data-id="${review.id}">
                    <div class="review-content" data-id="${review.id}">
                        <div class="flex items-start mb-3 space-x-4">
                            <!-- アルバムカバー画像 -->
                            <img src="${imageUrl}" alt="${review.title} Cover" 
                                 class="w-20 h-20 object-cover rounded-lg flex-shrink-0"
                                 onerror="this.onerror=null; this.src='${FALLBACK_IMAGE_URL}';"
                            >
                            <div class="flex-grow">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="text-xl font-bold text-indigo-400">${review.title}</h3>
                                        <p class="text-md text-gray-300">by ${review.artist}</p>
                                    </div>
                                    <div class="text-right flex-shrink-0 ml-4">
                                        <div class="text-2xl">${renderStars(review.rating)}</div>
                                        <p class="text-xs text-gray-500 mt-1">${timestamp}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p class="review-text text-gray-400 whitespace-pre-wrap leading-relaxed mt-2">${review.reviewText}</p>
                    </div>

                    <div class="review-actions mt-4 flex justify-end space-x-3">
                        <button class="edit-btn py-1 px-3 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-lg transition" data-id="${review.id}">
                            編集
                        </button>
                        <button class="delete-btn py-1 px-3 text-red-400 hover:text-red-500 text-sm font-medium rounded-lg transition" data-id="${review.id}">
                            削除
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * 全レビューを画面に描画する
         */
        function renderReviews() {
            // JSでタイムスタンプの降順でソート
            const sortedReviews = [...allReviewsData].sort((a, b) => b.timestamp - a.timestamp); 
            
            const searchTerm = searchArtistInput.value.toLowerCase().trim();
            
            const filteredReviews = sortedReviews.filter(review => {
                if (!searchTerm) return true; 
                return review.artist.toLowerCase().includes(searchTerm);
            });

            reviewsList.innerHTML = '';

            if (filteredReviews.length === 0) {
                noReviewsMessage.textContent = searchTerm 
                    ? `アーティスト名「${searchTerm}」に一致するレビューはありません。`
                    : 'まだレビューがありません。最初のレビューを書いてみましょう！';
                    
                noReviewsMessage.classList.remove('hidden');
                return;
            } else {
                noReviewsMessage.classList.add('hidden');
            }

            const reviewHtml = filteredReviews.map(createReviewCard).join('');
            reviewsList.innerHTML = reviewHtml;

            // イベントリスナーの設定
            reviewsList.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', handleDelete);
            });
            reviewsList.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', handleEditClick);
            });
        }
        
        /**
         * 編集モードの切り替えを処理する
         */
        function handleEditClick(event) {
            if (!isFirestoreReady) return showMessage('データ接続ができていないため、編集できません。', 'bg-red-900 text-red-300');

            const reviewId = event.target.dataset.id;
            const reviewCard = event.target.closest('.review-card');
            const review = allReviewsData.find(r => r.id === reviewId);
            
            if (!review) return;

            // 編集フォームのHTMLを生成
            const editFormHtml = `
                <form class="edit-form space-y-4 pt-4 border-t border-gray-700" data-id="${review.id}">
                    <h3 class="text-xl font-bold text-indigo-300">レビューの編集</h3>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">アルバム名</label>
                        <input type="text" name="title" value="${review.title}" required 
                               class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">アーティスト名</label>
                        <input type="text" name="artist" value="${review.artist}" required 
                               class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    
                    <div class="flex space-x-4 items-center">
                        <img src="${review.base64Image || FALLBACK_IMAGE_URL}" alt="Current Cover" class="w-16 h-16 object-cover rounded-lg flex-shrink-0">
                        <div class="flex-grow">
                            <label class="block text-sm font-medium text-gray-300 mb-1">新しいカバー画像 (変更する場合のみ)</label>
                            <input type="file" name="imageFile" accept="image/*"
                                   class="w-full file:mr-4 file:py-1 file:px-2 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-indigo-500 file:text-white hover:file:bg-indigo-600 p-1 bg-gray-700 border border-gray-600 rounded-lg text-gray-300">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">評価 (1〜5)</label>
                        <input type="number" name="rating" value="${review.rating}" min="1" max="5" required 
                               class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">レビュー本文</label>
                        <textarea name="reviewText" rows="4" required 
                                  class="w-full p-2 bg-gray-700 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">${review.reviewText}</textarea>
                    </div>
                    
                    <div class="flex justify-end space-x-3">
                        <button type="button" class="cancel-edit-btn py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition">キャンセル</button>
                        <button type="submit" class="save-edit-btn py-2 px-4 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg transition">保存</button>
                    </div>
                </form>
            `;
            
            reviewCard.innerHTML = editFormHtml;
            
            const editForm = reviewCard.querySelector('.edit-form');
            editForm.addEventListener('submit', handleSaveEdit);
            reviewCard.querySelector('.cancel-edit-btn').addEventListener('click', renderReviews);
        }

        /**
         * 編集内容の保存を処理する
         */
        async function handleSaveEdit(event) {
            event.preventDefault();

            // 🚨 強化されたチェック
            if (!isFirestoreReady || !db) {
                console.error("Database not ready for update.");
                return showMessage('データベース接続エラー: 接続準備ができていません。', 'bg-red-900 text-red-300');
            }

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // 内部で再取得
            const reviewId = event.target.dataset.id;
            const reviewDocRef = doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, reviewId);
            
            const formElements = event.target.elements;
            const newTitle = formElements.title.value.trim();
            const newArtist = formElements.artist.value.trim();
            const newRating = parseFloat(formElements.rating.value);
            const newReviewText = formElements.reviewText.value.trim();
            const newImageFile = formElements.imageFile.files[0];

            if (!newTitle || !newArtist || !newRating || !newReviewText || newRating < 1 || newRating > 5) {
                showMessage('全ての必須フィールドを正しく入力してください。', 'bg-red-900 text-red-300');
                return;
            }
            
            const base64Image = newImageFile 
                ? await fileToBase64(newImageFile) 
                : allReviewsData.find(r => r.id === reviewId)?.base64Image;

            const updateData = {
                title: newTitle,
                artist: newArtist,
                rating: newRating,
                reviewText: newReviewText,
                base64Image: base64Image || null,
                timestamp: serverTimestamp() 
            };

            try {
                await updateDoc(reviewDocRef, updateData);
                showMessage('レビューが正常に更新されました！', 'bg-green-900 text-green-300');
            } catch (error) {
                console.error("Error updating document:", error);
                showMessage(`レビューの更新に失敗しました: ${error.message}`, 'bg-red-900 text-red-300');
            }
        }

        /**
         * フォームの送信を処理する (新規投稿)
         */
        async function handleFormSubmit(event) {
            event.preventDefault();

            // 🚨 強化されたチェック
            if (!isFirestoreReady || !db) {
                console.error("Database not ready for submit.");
                return showMessage('データベース接続エラー: 接続準備ができていません。', 'bg-red-900 text-red-300');
            }
            
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // 内部で再取得
            const collectionRef = collection(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME);
            const title = document.getElementById('album-title').value.trim();
            const artist = document.getElementById('artist-name').value.trim();
            const rating = parseFloat(document.getElementById('rating').value);
            const reviewText = document.getElementById('review-text').value.trim();
            const imageFile = albumImageFileInput.files[0];

            if (!title || !artist || !rating || !reviewText) {
                showMessage('全てのフィールドを入力してください。', 'bg-red-900 text-red-300');
                return;
            }
            if (rating < 1 || rating > 5) {
                showMessage('評価は1から5の間で入力してください。', 'bg-red-900 text-red-300');
                return;
            }

            const base64Image = await fileToBase64(imageFile);

            const newReview = {
                title,
                artist,
                base64Image: base64Image || null,
                rating,
                reviewText,
                timestamp: serverTimestamp() 
            };

            try {
                // 投稿処理中はボタンを一時的に無効化し、二重投稿を防ぐ
                submitButton.disabled = true;
                submitButton.textContent = '投稿中...';

                await addDoc(collectionRef, newReview);
                
                form.reset();
                showMessage('レビューが正常に投稿されました！', 'bg-green-900 text-green-300');

            } catch (error) {
                console.error("Error adding document:", error);
                showMessage(`レビューの投稿に失敗しました: ${error.message}`, 'bg-red-900 text-red-300');
            } finally {
                // 処理完了後、ボタンを元に戻す (isFirestoreReadyがtrueであることを前提)
                if (isFirestoreReady) {
                    submitButton.disabled = false;
                    submitButton.textContent = 'レビューを投稿';
                }
            }
        }

        /**
         * レビューの削除を処理する
         */
        function handleDelete(event) {
            if (!isFirestoreReady || !db) {
                console.error("Database not ready for delete.");
                return showMessage('データベース接続エラー: 接続準備ができていません。', 'bg-red-900 text-red-300');
            }

            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; // 内部で再取得
            const reviewId = event.target.dataset.id;
            
            showCustomModal("レビューを削除しますか？", async () => {
                try {
                    const reviewDocRef = doc(db, 'artifacts', appId, 'public', 'data', COLLECTION_NAME, reviewId);
                    await deleteDoc(reviewDocRef);
                    showMessage('レビューが削除されました。', 'bg-red-900 text-red-300');
                } catch (error) {
                    console.error("Error deleting document:", error);
                    showMessage(`レビューの削除に失敗しました: ${error.message}`, 'bg-red-900 text-red-300');
                }
            });
        }
        
        /**
         * メッセージボックスを表示する
         */
        function showMessage(message, classes) {
            messageBox.textContent = message;
            messageBox.className = `mt-4 p-3 rounded-lg text-center ${classes}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000); 
        }
        
        // ==========================================================
        // カスタムモーダル（alertやconfirmの代替）
        // ==========================================================
        
        let modalElement = null;
        
        function createCustomModal() {
            const container = document.getElementById('custom-modal-container');
            if (container.querySelector('#custom-modal')) {
                modalElement = container.querySelector('#custom-modal');
                return;
            }

            const modalHtml = `
                <div id="custom-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden transition-opacity duration-300">
                    <div class="bg-gray-800 p-6 rounded-lg shadow-2xl max-w-sm w-full transform scale-95 transition-transform duration-300">
                        <p id="modal-text" class="text-lg mb-6 text-gray-200"></p>
                        <div class="flex justify-end space-x-3">
                            <button id="modal-cancel" class="py-2 px-4 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition">キャンセル</button>
                            <button id="modal-confirm" class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition">削除</button>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML = modalHtml;
            modalElement = container.querySelector('#custom-modal');
        }

        function showCustomModal(message, onConfirm) {
            if (!modalElement) createCustomModal();
            
            const modal = modalElement;
            document.getElementById('modal-text').textContent = message;

            const confirmBtn = document.getElementById('modal-confirm');
            const cancelBtn = document.getElementById('modal-cancel');

            const handleConfirm = () => {
                onConfirm();
                modal.classList.add('hidden');
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };

            const handleCancel = () => {
                modal.classList.add('hidden');
                confirmBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };

            confirmBtn.onclick = null;
            cancelBtn.onclick = null;
            
            confirmBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);

            modal.classList.remove('hidden');
        }


        // ==========================================================
        // 初期化処理
        // ==========================================================
        
        // フォーム送信イベントリスナー
        form.addEventListener('submit', handleFormSubmit);

        // 検索入力イベントリスナー
        searchArtistInput.addEventListener('input', renderReviews);

        // ページロード時に実行
        document.addEventListener('DOMContentLoaded', () => {
            createCustomModal(); 
            initializeFirebase();
        });

    </script>
</body>
</html>
